<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ì‹ ê´€ì‹¬ì¢…ëª© ì €ì¥ì†Œ - ê´€ì‹¬ì¢…ëª© ê·¸ë£¹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          darkMode: 'class'
        }
    </script>
    <script>
        (function() {
          const theme = localStorage.getItem('theme');
          if (theme === 'dark' ||
              (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        })();
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        #stock-list input,
        #stock-list select {
          text-align: center;
        }
        .grid > div {
            text-align: center;
        }
        #stockModal .bg-white {
    width: 400px; /* ì›í•˜ëŠ” ë„ˆë¹„ë¡œ ì„¤ì • */
    height: 450px; /* ì›í•˜ëŠ” ë†’ì´ë¡œ ì„¤ì • */
}
        #closeStockModal {
    position: absolute;
    bottom: 170px; /* ì•„ë˜ìª½ ì—¬ë°±ì„ ì„¤ì • */
    left: 50%;
    transform: translateX(-50%); /* ê°€ìš´ë° ì •ë ¬ */
}
    </style>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen dark:bg-gray-900 dark:text-gray-100">
<!-- ë¡œë”© í™”ë©´ -->
<div id="loading-screen" class="fixed inset-0 bg-white dark:bg-gray-900 flex flex-col items-center justify-center z-50 space-y-4">
    <!-- íšŒì „í•˜ëŠ” ë™ê·¸ë¼ë¯¸ -->
    <div class="w-12 h-12 border-4 border-gray-300 border-t-sky-600 rounded-full animate-spin"></div>

    <!-- ê¹œë¹¡ì´ëŠ” í…ìŠ¤íŠ¸ -->
    <div class="text-gray-800 dark:text-gray-100 text-xl font-bold animate-pulse">
        ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...
    </div>
</div>
<header class="bg-white shadow dark:bg-gray-800 dark:text-gray-100">
    <div class="container mx-auto px-4 py-6 flex justify-between items-center">
        <a th:href="@{/}" class="text-2xl font-bold text-sky-600">ì£¼ì‹ ê´€ì‹¬ì¢…ëª© ì €ì¥ì†Œ</a>

        <nav class="ml-auto flex items-center space-x-4">
            <a th:href="@{/stocks}"
               class="text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
                ì¢…ëª© ì •ë³´
            </a>
            <a th:href="@{/posts}"
               class="text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
                ì¢…ëª© í† ë¡ ë°©
            </a>
            <a th:href="@{/interest-group/my-groups}"
               class="text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
                ë‚´ ê´€ì‹¬ê·¸ë£¹
            </a>
            <a th:href="@{/my-account}"
               class="text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
                ë‚´ ì •ë³´
            </a>
            <a th:href="@{/oauth2/authorization/github}" sec:authorize="!isAuthenticated()"
               class="text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
                <i class="fab fa-github"></i> ë¡œê·¸ì¸
            </a>
            <a th:href="@{/logout}" sec:authorize="isAuthenticated()"
               class="text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
        <span sec:authentication="principal.name"
              class="text-gray-400 dark:text-gray-300 text-sm mx-1">username</span>
                ë¡œê·¸ì•„ì›ƒ
            </a>

            <!-- ë‹¤í¬ ëª¨ë“œ í† ê¸€ ë²„íŠ¼ -->
            <button id="darkModeToggle"
                    class="ml-4 text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
                <i id="darkModeIcon" class="fas fa-moon"></i>
            </button>
        </nav>
    </div>
</header>

<main class="container mx-auto px-4 py-8 flex-grow">
    <form name="interest-group-form" th:action="@{/interest-group}" method="post">
        <section class="bg-white shadow rounded-lg p-6 mb-6 dark:bg-gray-800" th:object="${interestGroup}">
            <!-- ì œëª© -->
            <h2 class="text-2xl font-bold text-gray-800 mb-6 dark:text-gray-100">
                <span th:if="*{groupName == null}">ê´€ì‹¬ì¢…ëª© ê·¸ë£¹ ë§Œë“¤ê¸°</span>
                <span th:unless="*{groupName == null}">ê´€ì‹¬ì¢…ëª© ê·¸ë£¹ ìˆ˜ì •í•˜ê¸°</span>
            </h2>

            <!-- ğŸ”¹ ê²½ê³ ë©”ì‹œì§€ ì˜ì—­ -->
            <div id="form-error" class="hidden mb-4 text-red-600 text-sm font-medium">
                â— ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¢…ëª©ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
            </div>

            <!-- ê·¸ë£¹ ì´ë¦„ -->
            <div class="flex items-start space-x-4 mb-4 flex-col sm:flex-row">
                <label for="groupName"
                       class="flex items-center justify-center text-sm font-medium text-gray-500 dark:text-gray-300 w-24 h-full">
                    ê·¸ë£¹ ì´ë¦„
                </label>
                <div class="w-full">
                    <input type="text" id="groupName"
                           th:field="*{groupName}"
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100"
                           th:attr="data-mode=${groupName != null ? 'edit' : 'create'}">
                    <!-- ìˆ˜ì • ëª¨ë“œì¼ ë•Œ ê²½ê³  í‘œì‹œ -->
                    <p id="groupName-warning"
                       class="mt-2 text-sm text-red-600 dark:text-red-400"
                       th:if="*{groupName != null}">
                        â— ê·¸ë£¹ ì´ë¦„ì„ ìˆ˜ì •í•˜ë©´ ìƒˆë¡œìš´ ê·¸ë£¹ì´ ìƒì„±ë©ë‹ˆë‹¤.
                    </p>
                    <!-- ë¡œê·¸ì¸ í•„ìš” ë©”ì‹œì§€ -->
                    <p id="login-warning"
                       class="mt-2 text-sm text-red-600 dark:text-red-400"
                       sec:authorize="!isAuthenticated()">
                        â— ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>


            <hr class="mb-4 border-gray-200 dark:border-gray-700">

            <div class="grid grid-cols-[1.5fr_1fr_1fr_1fr_1fr_1fr_1fr_1.5fr_50px] gap-4 mb-4">
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">ì¢…ëª©ëª…</div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">ë§¤ì…ê°€</div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">ë³´ìœ ìˆ˜ëŸ‰</div>
                <div class="flex flex-col text-sm font-medium text-gray-400 dark:text-gray-300">
                    <span>ë§¤ì…ê¸ˆì•¡</span>
                    <span>í‰ê°€ê¸ˆì•¡</span>
                </div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">í‰ê°€ì†ìµ</div>
                <div class="flex flex-col text-sm font-medium text-gray-400 dark:text-gray-300">
                    <span>ì‹¤í˜„ì†ìµ</span>
                    <span>ìˆ˜ìµë¥ </span>
                </div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">ì†ìµë¶„ê¸°ë§¤ì…ê°€</div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">í˜„ì¬ì£¼ê°€</div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">
                    <div class="relative">
                        <button onclick="submitForm()" class="absolute top-2 right-4 text-sm dark:text-white text-black bg-transparent p-2 rounded-full">
                            <i class="fas fa-sync-alt"></i> <!-- ìƒˆë¡œê³ ì¹¨ ì•„ì´ì½˜ -->
                        </button>
                    </div>
                </div>
            </div>

            <div id="interest-stock-list">
                <ul id="stock-list" class="list bg-white dark:bg-gray-900">
                    <li th:data-id="${iterStat.index + 1}"
                        class="grid grid-cols-[1.5fr_1fr_1fr_1fr_1fr_1fr_1fr_1.5fr_50px] gap-4 mb-4 bg-white dark:bg-gray-900"
                        th:each="item, iterStat : *{interestStocks}">

                        <!-- ì¢…ëª©ëª… (ë²„íŠ¼+ëª¨ë‹¬ ì„ íƒ) -->
                        <div class="flex items-center">
                            <i class="handle fas fa-grip-lines mr-2 cursor-move"></i>
                            <button type="button" class="stock-name-btn mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100">
                                <span th:text="${item.stockName} ?: '-- ì¢…ëª© ì„ íƒ --'">-- ì¢…ëª© ì„ íƒ --</span>
                            </button>
                            <input type="hidden" th:field="*{interestStocks[__${iterStat.index}__].stockName}" class="stock-name-value">
                        </div>

                        <!-- ë§¤ì…ê°€ -->
                        <div class="flex items-center">
                            <input type="text" th:field="*{interestStocks[__${iterStat.index}__].buyingPrice}"
                                   class="buying-price-id buying-price-name mt-1 block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100">
                        </div>

                        <!-- ë³´ìœ ìˆ˜ëŸ‰ -->
                        <div class="flex items-center">
                            <input type="text" th:field="*{interestStocks[__${iterStat.index}__].numOfStocks}"
                                   class="num-of-stocks-id num-of-stocks-name mt-1 block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100">
                        </div>

                        <!-- ë§¤ì…ê¸ˆì•¡ + í‰ê°€ê¸ˆì•¡ -->
                        <div class="flex flex-col space-y-1">
                            <input type="text" th:field="*{interestStocks[__${iterStat.index}__].totalBuyingPrice}"
                                   class="total-buying-price-id total-buying-price-name block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                            <input type="text" th:value="${item.valuation}"
                                   class="valuation-id valuation-name block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                        </div>

                        <!-- í‰ê°€ì†ìµ -->
                        <div class="flex items-center">
                            <input type="text" th:value="${item.unrealizedPL}"
                                   class="unrealized-pl-id unrealized-pl-name mt-1 block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                        </div>

                        <!-- ì‹¤í˜„ì†ìµ + ìˆ˜ìµë¥  -->
                        <div class="flex flex-col space-y-1">
                            <input type="text" th:value="${item.realizedPL}"
                                   class="realized-pl-id realized-pl-name block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                            <input type="text" th:value="${item.rateOfReturnString}"
                                   class="rate-of-return-id rate-of-return-name block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                        </div>

                        <!-- ì†ìµë¶„ê¸°ë§¤ì…ê°€ -->
                        <div class="flex items-center">
                            <input type="text" th:field="*{interestStocks[__${iterStat.index}__].breakEvenPrice}"
                                   class="break-even-price-id break-even-price-name mt-1 block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                        </div>

                        <!-- í˜„ì¬ì£¼ê°€ / ìƒìŠ¹ê°€ / ìƒìŠ¹ë¥  ì„¸ë¡œ ë°°ì¹˜ -->
                        <div class="flex flex-col space-y-1 relative">
                            <!-- ìœ„: í˜„ì¬ì£¼ê°€ -->
                            <div class="flex items-center">
                                <input type="text"
                                       th:value="${item.nowValue}"
                                       class="current-price-id current-price-name block w-full border-gray-300 rounded-md shadow-sm
                      dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100"
                                       readonly>
                            </div>

                            <!-- ì•„ë˜: ìƒìŠ¹ê°€ + ìƒìŠ¹ë¥  -->
                            <div class="flex items-center space-x-2">
                                <span class="change-icon w-4 text-center"></span>
                                <input type="text"
                                       th:value="${item.changeValue}"
                                       class="change-value-id change-value-name block w-1/2 border-gray-300 rounded-md shadow-sm
                      dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100"
                                       readonly>
                                <input type="text"
                                       th:value="${item.changeRateString}"
                                       class="change-rate-id change-rate-name block w-1/2 border-gray-300 rounded-md shadow-sm
                      dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100"
                                       readonly>
                            </div>
                        </div>

                        <!-- ì‚­ì œ ë²„íŠ¼ ì „ìš© ì¹¸ -->
                        <div class="flex items-center justify-center">
                            <i class="delete-row fas fa-trash ml-2 cursor-pointer"></i>
                        </div>

                        <input type="hidden" th:field="*{interestStocks[__${iterStat.index}__].fieldOrder}"
                               class="field-order-id field-order-name field-order-value">
                    </li>
                </ul>
            </div>

            <button type="button" id="add-row" class="mt-4 bg-sky-600 dark:bg-sky-500 text-white py-2 px-4 rounded hover:bg-sky-700 dark:hover:bg-sky-600">ì¢…ëª© ì¶”ê°€</button>
            <button type="submit" class="mt-4 bg-sky-600 dark:bg-sky-500 text-white py-2 px-4 rounded hover:bg-sky-700 dark:hover:bg-sky-600">ì €ì¥</button>
        </section>
    </form>
</main>

<!-- ëª¨ë‹¬ HTML -->
<div id="stockModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-lg w-96 p-6">
        <h2 class="text-lg font-bold mb-4 dark:text-gray-100">ì¢…ëª© ì„ íƒ</h2>
        <!-- ê²€ìƒ‰ ì…ë ¥ë€ -->
        <input type="text" id="stockSearch" placeholder="ê²€ìƒ‰..." class="mb-4 w-full p-2 border rounded-md dark:bg-gray-700 dark:text-gray-100">
        <ul id="stockListModal" class="max-h-60 overflow-y-auto space-y-2">
            <li th:each="name : ${stockNames}"
                class="cursor-pointer hover:bg-sky-100 dark:hover:bg-gray-700 p-2 rounded"
                th:data-value="${name}"
                th:text="${name}">
            </li>
        </ul>
        <button id="closeStockModal" class="mt-4 bg-gray-300 dark:bg-gray-700 px-4 py-2 rounded">ë‹«ê¸°</button>
    </div>
</div>

<footer class="bg-white shadow w-full mt-auto dark:bg-gray-800 dark:text-gray-400">
    <div class="container mx-auto px-4 py-6 text-center text-gray-600 dark:text-gray-300" >
        Â© 2025 Arile, Inc
    </div>
</footer>

<script>
    const interestStockList = new List('interest-stock-list', {
        valueNames: [
            { data: ['id'] },
            { name: 'stock-name-value', attr: 'value' },
            { name: 'buying-price-id', attr: 'id' },
            { name: 'buying-price-name', attr: 'name' },
            { name: 'num-of-stocks-id', attr: 'id' },
            { name: 'num-of-stocks-name', attr: 'name' },
            { name: 'total-buying-price-id', attr: 'id' },
            { name: 'total-buying-price-name', attr: 'name' },
            { name: 'valuation-id', attr: 'id' },
            { name: 'valuation-name', attr: 'name' },
            { name: 'unrealized-pl-id', attr: 'id' },
            { name: 'unrealized-pl-name', attr: 'name' },
            { name: 'realized-pl-id', attr: 'id' },
            { name: 'realized-pl-name', attr: 'name' },
            { name: 'rate-of-return-id', attr: 'id' },
            { name: 'rate-of-return-name', attr: 'name' },
            { name: 'break-even-price-id', attr: 'id' },
            { name: 'break-even-price-name', attr: 'name' },
            { name: 'current-price-id', attr: 'id' },
            { name: 'current-price-name', attr: 'name' },
            { name: 'change-value-id', attr: 'id' },
            { name: 'change-value-name', attr: 'name' },
            { name: 'change-rate-id', attr: 'id' },
            { name: 'change-rate-name', attr: 'name' },
            { name: 'field-order-id', attr: 'id' },
            { name: 'field-order-name', attr: 'name' },
            { name: 'field-order-value', attr: 'value' },
        ]
    });
    interestStockList.sort('field-order-value', { order: 'asc' });

    const sortable = new Sortable.create(document.getElementById('stock-list'), {
        handle: '.handle',
        animation: 150,
        onUpdate: () => { resetData(interestStockList); }
    });

    document.querySelectorAll('.delete-row').forEach(btn => {
        enrollDeleteRowEvent(btn, interestStockList);
    });

    interestStockList.on('updated', list => resetData(list));

<!--    document.getElementById('add-row').addEventListener('click', () => {-->
<!--        interestStockList.add({});-->
<!--        const lastRow = interestStockList.items.at(-1).elm;-->

<!--        lastRow.querySelectorAll(-->
<!--            '.buying-price-name, .num-of-stocks-name, .total-buying-price-name, .valuation-name, .unrealized-pl-name, .realized-pl-name, .rate-of-return-name, .break-even-price-name, .current-price-name, .change-value-name, .change-rate-name'-->
<!--        ).forEach(input => input.value = '');-->

<!--        const selectBox = lastRow.querySelector('select');-->
<!--        if (selectBox) selectBox.selectedIndex = 0;-->

<!--        enrollDeleteRowEvent(lastRow.querySelector('.delete-row'), interestStockList);-->
<!--        attachNumberFormatting();-->

<!--        document.getElementById('form-error').classList.add('hidden');-->
<!--    });-->

    function enrollDeleteRowEvent(btn, list) {
    btn.addEventListener('click', e => {
        const stockList = document.querySelectorAll('#stock-list li');

        // ìµœì†Œ 1ê°œ í–‰ì€ ìœ ì§€í•´ì•¼ í•¨
        if (stockList.length <= 1) {
            const formError = document.getElementById("form-error");
            formError.classList.remove("hidden");
            formError.innerText = "â— ìµœì†Œ 1ê°œ ì´ìƒì˜ ì¢…ëª©ì€ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.";
            return;
        }

        // ì‹¤ì œ ì‚­ì œ ì²˜ë¦¬
        const parentList = e.target.closest('li');
        const fieldOrderInput = parentList.querySelector('.field-order-value');
        if (fieldOrderInput) list.remove('field-order-value', fieldOrderInput.value);
        parentList.remove();

        // ì‚­ì œ í›„ reIndex
        resetData(list);
    });
}

    function resetData(list) {
        list.reIndex();
        for (const [index, item] of list.items.entries()) {
            item.values({
                'id': index + 1,
                'stock-name-value': item.elm.querySelector('.stock-name-value').value,
                'buying-price-id': `interestStocks${index}.buyingPrice`,
                'buying-price-name': `interestStocks[${index}].buyingPrice`,
                'num-of-stocks-id': `interestStocks${index}.numOfStocks`,
                'num-of-stocks-name': `interestStocks[${index}].numOfStocks`,
                'total-buying-price-id': `interestStocks${index}.totalBuyingPrice`,
                'total-buying-price-name': `interestStocks[${index}].totalBuyingPrice`,

                'valuation-id': `interestStocks${index}.valuation`,
                'valuation-name': `interestStocks[${index}].valuation`,
                'unrealized-pl-id': `interestStocks${index}.unrealizedPL`,
                'unrealized-pl-name': `interestStocks[${index}].unrealizedPL`,
                'realized-pl-id': `interestStocks${index}.realizedPL`,
                'realized-pl-name': `interestStocks[${index}].realizedPL`,
                'rate-of-return-id': `interestStocks${index}.rateOfReturnString`,
                'rate-of-return-name': `interestStocks[${index}].rateOfReturnString`,

                'break-even-price-id': `interestStocks${index}.breakEvenPrice`,
                'break-even-price-name': `interestStocks[${index}].breakEvenPrice`,
                'current-price-id': `interestStocks${index}.nowValue`,
                'current-price-name': `interestStocks[${index}].nowValue`,
                'change-value-id': `interestStocks${index}.changeValue`,
                'change-value-name': `interestStocks[${index}].changeValue`,
                'change-rate-id': `interestStocks${index}.changeRateString`,
                'change-rate-name': `interestStocks[${index}].changeRateString`,
                'field-order-id': `interestStocks${index}.fieldOrder`,
                'field-order-name': `interestStocks[${index}].fieldOrder`,
                'field-order-value': index + 1,
            });
            const stockInput = item.elm.querySelector('.stock-name-value');
            if (stockInput) {
                stockInput.name = `interestStocks[${index}].stockName`;
                stockInput.id   = `interestStocks${index}.stockName`;
            }
        }
        colorChangeValues();
        colorChangeRates();
        colorRealizedPLValues();
        colorRateOfReturn();
    }

    function formatNumberInput(input) {
        let value = input.value.replace(/,/g, '');
        if (value === '' || isNaN(value)) {
            input.value = '';
            return;
        }
        value = Math.floor(Number(value));
        input.value = value.toLocaleString('ko-KR');
    }

    function attachNumberFormatting() {
        const numberFields = document.querySelectorAll(
            '.buying-price-name, .num-of-stocks-name, .total-buying-price-name, .valuation-name, .unrealized-pl-name, .realized-pl-name, .break-even-price-name, .current-price-name, .change-value-name'
        );
        numberFields.forEach(field => {
            field.addEventListener('input', () => {
                const start = field.selectionStart;
                formatNumberInput(field);
                field.setSelectionRange(start, start);
            });
            if (field.value) formatNumberInput(field);
        });
        colorChangeValues();
        colorChangeRates();
        colorRealizedPLValues();
        colorRateOfReturn();
    }

    function colorChangeValues() {
        document.querySelectorAll('.change-value-name').forEach(el => {
            const val = parseFloat(el.value.replace(/,/g, ''));
            const iconEl = el.closest('div').querySelector('.change-icon');
            if (isNaN(val)) {
                el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');
                if(iconEl) iconEl.textContent = '';
                return;
            }
            el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');
            if(iconEl) iconEl.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');

            if (val > 0) {
                el.classList.add('text-red-600', 'dark:text-red-400');
                if (iconEl) { iconEl.textContent = 'â–²'; iconEl.classList.add('text-red-600', 'dark:text-red-400'); }
            }
            else if (val < 0) {
                el.classList.add('text-blue-600', 'dark:text-blue-400');
                if (iconEl) { iconEl.textContent = 'â–¼'; iconEl.classList.add('text-blue-600', 'dark:text-blue-400'); }
            }
            else {
                el.classList.add('text-gray-500', 'dark:text-gray-400');
                if (iconEl) { iconEl.textContent = '-'; iconEl.classList.add('text-gray-500', 'dark:text-gray-400'); }
            }
        });
    }


    function colorRealizedPLValues() {
        document.querySelectorAll('.realized-pl-name').forEach(el => {
            const val = parseFloat(el.value.replace(/,/g, ''));
            if (isNaN(val)) {
                el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');
                return;
            }
            el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');

            if (val > 0) {
                el.classList.add('text-red-600', 'dark:text-red-400');
            }
            else if (val < 0) {
                el.classList.add('text-blue-600', 'dark:text-blue-400');
            }
            else {
                el.classList.add('text-gray-500', 'dark:text-gray-400');
            }
        });
    }


    function colorChangeRates() {
    document.querySelectorAll('#stock-list li').forEach(row => {
        const changeRateEl = row.querySelector('.change-rate-name');
        const changeValueEl = row.querySelector('.change-value-name');

        if (!changeRateEl || !changeValueEl) return;

        let val = parseFloat(changeValueEl.value.replace(/,/g, ''));

        // ë¨¼ì € ìƒ‰ìƒ ì´ˆê¸°í™”
        changeRateEl.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');

        if (isNaN(val) || val === 0) {
            changeRateEl.classList.add('text-gray-500', 'dark:text-gray-400');
        } else if (val > 0) {
            changeRateEl.classList.add('text-red-600', 'dark:text-red-400');
        } else {
            changeRateEl.classList.add('text-blue-600', 'dark:text-blue-400');
        }
    });
}


    function colorRateOfReturn() {
    document.querySelectorAll('#stock-list li').forEach(row => {
        const realizedPLEl = row.querySelector('.realized-pl-name');
        const rateOfReturnEl = row.querySelector('.rate-of-return-name');

        if (!realizedPLEl || !rateOfReturnEl) return;

        let val = parseFloat(realizedPLEl.value.replace(/,/g, ''));

        // ë¨¼ì € ìƒ‰ìƒ ì´ˆê¸°í™”
        rateOfReturnEl.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
        'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');

        if (isNaN(val) || val === 0) {
            rateOfReturnEl.classList.add('text-gray-500', 'dark:text-gray-400');
        } else if (val > 0) {
            rateOfReturnEl.classList.add('text-red-600', 'dark:text-red-400');
        } else {
            rateOfReturnEl.classList.add('text-blue-600', 'dark:text-blue-400');
        }
    });
}

    document.addEventListener('DOMContentLoaded', () => {
    attachNumberFormatting();
    const form = document.querySelector('form[name="interest-group-form"]');
    if (form) {
        form.addEventListener('submit', (e) => {
            const stockValues = document.querySelectorAll('#stock-list li .stock-name-value');
            const errorBox = document.getElementById('form-error');

            // ì¢…ëª© ì„ íƒ ì—¬ë¶€ ì²´í¬
            for (const input of stockValues) {
                if (!input.value) {
                    e.preventDefault();
                    errorBox.textContent = 'â— ì¢…ëª©ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.';
                    errorBox.classList.remove('hidden');
                    return;
                }
            }
            errorBox.classList.add('hidden');

            // ìˆ«ì í•„ë“œ ì½¤ë§ˆ ì œê±°
            const numberFields = document.querySelectorAll(
                '.buying-price-name, .num-of-stocks-name, .total-buying-price-name, .break-even-price-name'
            );
            numberFields.forEach(field => field.value = field.value.replace(/,/g, ''));
        });
    }
});
</script>

<script>
    const toggleBtn = document.getElementById("darkModeToggle");
    const icon = document.getElementById("darkModeIcon");
    const root = document.documentElement;

    // ì €ì¥ëœ ëª¨ë“œ ë¶ˆëŸ¬ì˜¤ê¸°
    if (localStorage.getItem("theme") === "dark") {
      root.classList.add("dark");
      icon.classList.replace("fa-moon","fa-sun");
    }

    toggleBtn.addEventListener("click", () => {
      const isDark = root.classList.toggle("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      icon.classList.toggle("fa-moon", !isDark);
      icon.classList.toggle("fa-sun", isDark);
    });
</script>

<script>
    // ëª¨ë‹¬ ì¢…ëª© ì„ íƒ ê¸°ëŠ¥
    function openStockModal(btn) {
        window.currentStockBtn = btn;
        document.getElementById('stockModal').classList.remove('hidden');
    }

    function enrollStockBtnEvent(btn) {
        btn.addEventListener('click', () => openStockModal(btn));
    }

    document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('stockModal');
    const closeBtn = document.getElementById('closeStockModal');
    const stockItems = document.querySelectorAll('#stockListModal li');
    const searchInput = document.getElementById('stockSearch');  // ê²€ìƒ‰ ì…ë ¥ í•„ë“œ

    // ì¢…ëª© í´ë¦­ ì‹œ ì„ íƒ ì²˜ë¦¬
    stockItems.forEach(li => {
        li.addEventListener('click', () => {
            if (window.currentStockBtn) {
                window.currentStockBtn.querySelector('span').textContent = li.dataset.value;
                const hiddenInput = window.currentStockBtn.parentElement.querySelector('.stock-name-value');
                hiddenInput.value = li.dataset.value;
            }
            modal.classList.add('hidden');
        });
    });

    // ëª¨ë‹¬ ë‹«ê¸°
    closeBtn.addEventListener('click', () => modal.classList.add('hidden'));

    // ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();

        stockItems.forEach(item => {
            const stockName = item.textContent.toLowerCase();
            if (stockName.includes(searchTerm)) {
                item.style.display = 'block'; // ê²€ìƒ‰ì–´ì™€ ì¼ì¹˜í•˜ë©´ í‘œì‹œ
            } else {
                item.style.display = 'none'; // ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ìˆ¨ê¹€
            }
        });
    });

    // ì¢…ëª© ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë“±ë¡
    document.querySelectorAll('.stock-name-btn').forEach(enrollStockBtnEvent);
});



document.getElementById('add-row').addEventListener('click', () => {
    const stockList = document.getElementById('stock-list');
    const firstRow = stockList.querySelector('li');
    const newRow = firstRow.cloneNode(true);

    // ëª¨ë“  input ì´ˆê¸°í™”
    newRow.querySelectorAll('input').forEach(input => input.value = '');

    // ì¢…ëª© ë²„íŠ¼ ì´ˆê¸°í™”
    const stockBtn = newRow.querySelector('.stock-name-btn');
    stockBtn.querySelector('span').textContent = '-- ì¢…ëª© ì„ íƒ --';

    // ìƒˆ index ê³„ì‚°
    const index = stockList.children.length;

    // ëª¨ë“  inputì˜ name/id/value ê°±ì‹ 
    newRow.querySelectorAll('input').forEach(input => {
        if (input.classList.contains('stock-name-value')) {
            input.name = `interestStocks[${index}].stockName`;
            input.id = `interestStocks${index}.stockName`;
        } else if (input.classList.contains('buying-price-name')) {
            input.name = `interestStocks[${index}].buyingPrice`;
            input.id = `interestStocks${index}.buyingPrice`;
        } else if (input.classList.contains('num-of-stocks-name')) {
            input.name = `interestStocks[${index}].numOfStocks`;
            input.id = `interestStocks${index}.numOfStocks`;
        } else if (input.classList.contains('total-buying-price-name')) {
            input.name = `interestStocks[${index}].totalBuyingPrice`;
            input.id = `interestStocks${index}.totalBuyingPrice`;
        } else if (input.classList.contains('valuation-name')) {
            input.name = `interestStocks[${index}].valuation`;
            input.id = `interestStocks${index}.valuation`;
        } else if (input.classList.contains('unrealized-pl-name')) {
            input.name = `interestStocks[${index}].unrealizedPL`;
            input.id = `interestStocks${index}.unrealizedPL`;
        } else if (input.classList.contains('realized-pl-name')) {
            input.name = `interestStocks[${index}].realizedPL`;
            input.id = `interestStocks${index}.realizedPL`;
        } else if (input.classList.contains('rate-of-return-name')) {
            input.name = `interestStocks[${index}].rateOfReturnString`;
            input.id = `interestStocks${index}.rateOfReturnString`;
        } else if (input.classList.contains('break-even-price-name')) {
            input.name = `interestStocks[${index}].breakEvenPrice`;
            input.id = `interestStocks${index}.breakEvenPrice`;
        } else if (input.classList.contains('current-price-name')) {
            input.name = `interestStocks[${index}].nowValue`;
            input.id = `interestStocks${index}.nowValue`;
        } else if (input.classList.contains('change-value-name')) {
            input.name = `interestStocks[${index}].changeValue`;
            input.id = `interestStocks${index}.changeValue`;
        } else if (input.classList.contains('change-rate-name')) {
            input.name = `interestStocks[${index}].changeRateString`;
            input.id = `interestStocks${index}.changeRateString`;
        } else if (input.classList.contains('field-order-value')) {
            input.name = `interestStocks[${index}].fieldOrder`;
            input.id = `interestStocks${index}.fieldOrder`;
            input.value = index + 1;
        }
    });

    // delete ë²„íŠ¼ & ëª¨ë‹¬ ì´ë²¤íŠ¸ ë“±ë¡
    enrollStockBtnEvent(stockBtn);
    enrollDeleteRowEvent(newRow.querySelector('.delete-row'), interestStockList);

    stockList.appendChild(newRow);

    // List.js ì¸ë±ìŠ¤ ì¬ì„¤ì •
    resetData(interestStockList);
    attachNumberFormatting();
});
</script>
<script>
    window.addEventListener('load', () => {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.style.transition = "opacity 0.5s";
        loadingScreen.style.opacity = 0;
        setTimeout(() => loadingScreen.remove(), 500);
      }
    });
</script>
</body>
</html>
