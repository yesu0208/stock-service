<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주식 관심종목 저장소 - 관심종목 그룹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen">

<header class="bg-white shadow">
    <div class="container mx-auto px-4 py-6 flex justify-between items-center">
        <a th:href="@{/}" class="text-2xl font-bold text-sky-600">주식 관심종목 저장소</a>
        <nav>
            <a th:href="@{/interest-group/my-groups}" class="text-gray-600 hover:text-sky-600 mx-2">내 관심그룹</a>
            <a th:href="@{/my-account}" class="text-gray-600 hover:text-sky-600 mx-2">내 정보</a>
            <a th:href="@{/oauth2/authorization/github}" sec:authorize="!isAuthenticated()" class="text-gray-600 hover:text-sky-600 mx-2"><i class="fab fa-github"></i> 로그인</a>
            <a th:href="@{/logout}" sec:authorize="isAuthenticated()" class="text-gray-600 hover:text-sky-600 mx-2">
                <span sec:authentication="principal.name" class="text-gray-400 text-sm mx-1">username</span>
                로그아웃
            </a>
        </nav>
    </div>
</header>

<main class="container mx-auto px-4 py-8 flex-grow">
    <form name="interest-group-form" th:action="@{/interest-group}" method="post">
        <section class="bg-white shadow rounded-lg p-6 mb-6" th:object="${interestGroup}">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">관심종목 그룹 만들기</h2>

            <!-- 🔹 경고메시지 영역 -->
            <div id="form-error" class="hidden mb-4 text-red-600 text-sm font-medium">
                ❗ 최소 1개 이상의 종목을 추가해야 합니다.
            </div>

            <div class="flex items-center space-x-4 mb-4">
                <label for="groupName" class="block text-sm font-medium text-gray-500 w-24">그룹이름</label>
                <input type="text" id="groupName" th:field="*{groupName}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
            </div>

            <hr class="mb-4">

            <!-- 컬럼 8개: 기존 5 + 현재주가/상승가격/상승률 -->
            <div class="grid grid-cols-[1.5fr_1fr_1fr_1fr_1fr_1fr_1fr_1fr_1fr_1.7fr] gap-4 mb-4">
                <div class="block text-sm font-medium text-gray-400">종목명</div>
                <div class="block text-sm font-medium text-gray-400">매입가</div>
                <div class="block text-sm font-medium text-gray-400">보유수량</div>
                <div class="block text-sm font-medium text-gray-400">매입금액</div>
                <div class="block text-sm font-medium text-gray-400">평가금액</div>
                <div class="block text-sm font-medium text-gray-400">평가손익</div>
                <div class="block text-sm font-medium text-gray-400">실현손익</div>
                <div class="block text-sm font-medium text-gray-400">수익률</div>
                <div class="block text-sm font-medium text-gray-400">손익분기매입가</div>
                <div class="block text-sm font-medium text-gray-400">현재주가</div>
            </div>

            <div id="interest-stock-list">
                <ul id="stock-list" class="list">
                    <li th:data-id="${iterStat.index + 1}" class="grid grid-cols-[1.5fr_1fr_1fr_1fr_1fr_1fr_1fr_1fr_1fr_1.7fr] gap-4 mb-4" th:each="item, iterStat : *{interestStocks}">
                        <div class="flex items-center">
                            <i class="handle fas fa-grip-lines mr-2 cursor-move"></i>
                            <label>
                                <select th:field="*{interestStocks[__${iterStat.index}__].stockName}" class="stock-name-id stock-name-name mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                                    <option value="" disabled selected>-- 종목선택 --</option>
                                    <option th:each="type : ${stockNames}" th:value="${type}" th:text="${type}">Type</option>
                                </select>
                            </label>
                        </div>
                        <div class="flex items-center">
                            <input type="text" th:field="*{interestStocks[__${iterStat.index}__].buyingPrice}" class="buying-price-id buying-price-name mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="flex items-center">
                            <input type="text" th:field="*{interestStocks[__${iterStat.index}__].numOfStocks}" class="num-of-stocks-id num-of-stocks-name mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="flex items-center">
                            <input type="text"
                                   th:field="*{interestStocks[__${iterStat.index}__].totalBuyingPrice}"
                                   class="total-buying-price-id total-buying-price-name mt-1 block w-full border-gray-300 rounded-md shadow-sm"
                                   readonly>
                        </div>
                        <div class="flex items-center">
                            <input type="text"
                                   th:value="${item.valuation}"
                                   class="valuation-id valuation-name mt-1 block w-full border-gray-300 rounded-md shadow-sm"
                                   readonly>
                        </div>
                        <div class="flex items-center">
                            <input type="text"
                                   th:value="${item.unrealizedPL}"
                                   class="unrealized-pl-id unrealized-pl-name mt-1 block w-full border-gray-300 rounded-md shadow-sm"
                                   readonly>
                        </div>
                        <div class="flex items-center">
                            <input type="text"
                                   th:value="${item.realizedPL}"
                                   class="realized-pl-id realized-pl-name mt-1 block w-full border-gray-300 rounded-md shadow-sm"
                                   readonly>
                        </div>
                        <div class="flex items-center">
                            <input type="text"
                                   th:value="${item.rateOfReturnString}"
                                   class="rate-of-return-id rate-of-return-name mt-1 block w-full border-gray-300 rounded-md shadow-sm"
                                   readonly>
                        </div>
                        <div class="flex items-center">
                            <input type="text"
                                   th:field="*{interestStocks[__${iterStat.index}__].breakEvenPrice}"
                                   class="break-even-price-id break-even-price-name mt-1 block w-full border-gray-300 rounded-md shadow-sm"
                                   readonly>
                        </div>
                        <!-- 현재주가 / 상승가 / 상승률 -->
                        <div class="flex items-center space-x-2">
                            <input type="text"
                                   th:value="${item.nowValue}"
                                   class="current-price-id current-price-name mt-1 block w-1/3 border-gray-300 rounded-md shadow-sm"
                                   readonly>
                            <span class="change-icon w-4 text-center"></span>
                            <input type="text"
                                   th:value="${item.changeValue}"
                                   class="change-value-id change-value-name mt-1 block w-1/3 border-gray-300 rounded-md shadow-sm"
                                   readonly>
                            <input type="text"
                                   th:value="${item.changeRateString}"
                                   class="change-rate-id change-rate-name mt-1 block w-1/3 border-gray-300 rounded-md shadow-sm"
                                   readonly>
                            <i class="delete-row fas fa-trash ml-2 cursor-pointer"></i>
                        </div>
                        <input type="hidden" th:field="*{interestStocks[__${iterStat.index}__].fieldOrder}" class="field-order-id field-order-name field-order-value">
                    </li>
                </ul>
            </div>

            <button type="button" id="add-row" class="mt-4 bg-sky-600 text-white py-2 px-4 rounded hover:bg-sky-700">종목 추가</button>
            <button type="submit" class="mt-4 bg-sky-600 text-white py-2 px-4 rounded hover:bg-sky-700">저장</button>
        </section>
    </form>
</main>

<footer class="bg-white shadow w-full mt-auto">
    <div class="container mx-auto px-4 py-6 text-center text-gray-600">
        © 2025 Arile, Inc
    </div>
</footer>

<script>
    const interestStockList = new List('interest-stock-list', {
        valueNames: [
            { data: ['id'] },
            { name: 'stock-name-id', attr: 'id' },
            { name: 'stock-name-name', attr: 'name' },
            { name: 'buying-price-id', attr: 'id' },
            { name: 'buying-price-name', attr: 'name' },
            { name: 'num-of-stocks-id', attr: 'id' },
            { name: 'num-of-stocks-name', attr: 'name' },
            { name: 'total-buying-price-id', attr: 'id' },
            { name: 'total-buying-price-name', attr: 'name' },
            { name: 'valuation-id', attr: 'id' },
            { name: 'valuation-name', attr: 'name' },
            { name: 'unrealized-pl-id', attr: 'id' },
            { name: 'unrealized-pl-name', attr: 'name' },
            { name: 'realized-pl-id', attr: 'id' },
            { name: 'realized-pl-name', attr: 'name' },
            { name: 'rate-of-return-id', attr: 'id' },
            { name: 'rate-of-return-name', attr: 'name' },
            { name: 'break-even-price-id', attr: 'id' },
            { name: 'break-even-price-name', attr: 'name' },
            { name: 'current-price-id', attr: 'id' },
            { name: 'current-price-name', attr: 'name' },
            { name: 'change-value-id', attr: 'id' },
            { name: 'change-value-name', attr: 'name' },
            { name: 'change-rate-id', attr: 'id' },
            { name: 'change-rate-name', attr: 'name' },
            { name: 'field-order-id', attr: 'id' },
            { name: 'field-order-name', attr: 'name' },
            { name: 'field-order-value', attr: 'value' },
        ]
    });
    interestStockList.sort('field-order-value', { order: 'asc' });

    const sortable = new Sortable.create(document.getElementById('stock-list'), {
        handle: '.handle',
        animation: 150,
        onUpdate: () => { resetData(interestStockList); }
    });

    document.querySelectorAll('.delete-row').forEach(btn => {
        enrollDeleteRowEvent(btn, interestStockList);
    });

    interestStockList.on('updated', list => resetData(list));

    document.getElementById('add-row').addEventListener('click', () => {
        interestStockList.add({});
        const lastRow = interestStockList.items.at(-1).elm;

        lastRow.querySelectorAll(
            '.buying-price-name, .num-of-stocks-name, .total-buying-price-name, .valuation-name, .unrealized-pl-name, .realized-pl-name, .rate-of-return-name, .break-even-price-name, .current-price-name, .change-value-name, .change-rate-name'
        ).forEach(input => input.value = '');

        const selectBox = lastRow.querySelector('select');
        if (selectBox) selectBox.selectedIndex = 0;

        enrollDeleteRowEvent(lastRow.querySelector('.delete-row'), interestStockList);
        attachNumberFormatting();

        document.getElementById('form-error').classList.add('hidden');
    });

    function enrollDeleteRowEvent(btn, list) {
        btn.addEventListener('click', e => {
            const parentList = e.target.closest('li');
            const fieldOrderInput = parentList.querySelector('.field-order-value');
            if (fieldOrderInput) list.remove('field-order-value', fieldOrderInput.value);
            parentList.remove();
        });
    }

    function resetData(list) {
        list.reIndex();
        for (const [index, item] of list.items.entries()) {
            item.values({
                'id': index + 1,
                'stock-name-id': `interestStocks${index}.stockName`,
                'stock-name-name': `interestStocks[${index}].stockName`,
                'buying-price-id': `interestStocks${index}.buyingPrice`,
                'buying-price-name': `interestStocks[${index}].buyingPrice`,
                'num-of-stocks-id': `interestStocks${index}.numOfStocks`,
                'num-of-stocks-name': `interestStocks[${index}].numOfStocks`,
                'total-buying-price-id': `interestStocks${index}.totalBuyingPrice`,
                'total-buying-price-name': `interestStocks[${index}].totalBuyingPrice`,

                'valuation-id': `interestStocks${index}.valuation`,
                'valuation-name': `interestStocks[${index}].valuation`,
                'unrealized-pl-id': `interestStocks${index}.unrealizedPL`,
                'unrealized-pl-name': `interestStocks[${index}].unrealizedPL`,
                'realized-pl-id': `interestStocks${index}.realizedPL`,
                'realized-pl-name': `interestStocks[${index}].realizedPL`,
                'rate-of-return-id': `interestStocks${index}.rateOfReturnString`,
                'rate-of-return-name': `interestStocks[${index}].rateOfReturnString`,

                'break-even-price-id': `interestStocks${index}.breakEvenPrice`,
                'break-even-price-name': `interestStocks[${index}].breakEvenPrice`,
                'current-price-id': `interestStocks${index}.nowValue`,
                'current-price-name': `interestStocks[${index}].nowValue`,
                'change-value-id': `interestStocks${index}.changeValue`,
                'change-value-name': `interestStocks[${index}].changeValue`,
                'change-rate-id': `interestStocks${index}.changeRateString`,
                'change-rate-name': `interestStocks[${index}].changeRateString`,
                'field-order-id': `interestStocks${index}.fieldOrder`,
                'field-order-name': `interestStocks[${index}].fieldOrder`,
                'field-order-value': index + 1,
            });
        }
        colorChangeValues();
        colorChangeRates();
        colorRealizedPLValues();
        colorRateOfReturn();
    }

    function formatNumberInput(input) {
        let value = input.value.replace(/,/g, '');
        if (value === '' || isNaN(value)) {
            input.value = '';
            return;
        }
        value = Math.floor(Number(value));
        input.value = value.toLocaleString('ko-KR');
    }

    function attachNumberFormatting() {
        const numberFields = document.querySelectorAll(
            '.buying-price-name, .num-of-stocks-name, .total-buying-price-name, .valuation-name, .unrealized-pl-name, .realized-pl-name, .break-even-price-name, .current-price-name, .change-value-name'
        );
        numberFields.forEach(field => {
            field.addEventListener('input', () => {
                const start = field.selectionStart;
                formatNumberInput(field);
                field.setSelectionRange(start, start);
            });
            if (field.value) formatNumberInput(field);
        });
        colorChangeValues();
        colorChangeRates();
        colorRealizedPLValues();
        colorRateOfReturn();
    }

    function colorChangeValues() {
        document.querySelectorAll('.change-value-name').forEach(el => {
            const val = parseFloat(el.value.replace(/,/g, ''));
            const iconEl = el.closest('div').querySelector('.change-icon');
            if (isNaN(val)) {
                el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500');
                if(iconEl) iconEl.textContent = '';
                return;
            }
            el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500');
            if(iconEl) iconEl.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500');

            if (val > 0) {
                el.classList.add('text-red-600');
                if (iconEl) { iconEl.textContent = '▲'; iconEl.classList.add('text-red-600'); }
            }
            else if (val < 0) {
                el.classList.add('text-blue-600');
                if (iconEl) { iconEl.textContent = '▼'; iconEl.classList.add('text-blue-600'); }
            }
            else {
                el.classList.add('text-gray-500');
                if (iconEl) { iconEl.textContent = '-'; iconEl.classList.add('text-gray-500'); }
            }
        });
    }


    function colorRealizedPLValues() {
        document.querySelectorAll('.realized-pl-name').forEach(el => {
            const val = parseFloat(el.value.replace(/,/g, ''));
            if (isNaN(val)) {
                el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500');
                return;
            }
            el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500');

            if (val > 0) {
                el.classList.add('text-red-600');
            }
            else if (val < 0) {
                el.classList.add('text-blue-600');
            }
            else {
                el.classList.add('text-gray-500');
            }
        });
    }


    function colorChangeRates() {
    document.querySelectorAll('#stock-list li').forEach(row => {
        const changeRateEl = row.querySelector('.change-rate-name');
        const changeValueEl = row.querySelector('.change-value-name');

        if (!changeRateEl || !changeValueEl) return;

        let val = parseFloat(changeValueEl.value.replace(/,/g, ''));

        // 먼저 색상 초기화
        changeRateEl.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500');

        if (isNaN(val) || val === 0) {
            changeRateEl.classList.add('text-gray-500');
        } else if (val > 0) {
            changeRateEl.classList.add('text-red-600');
        } else {
            changeRateEl.classList.add('text-blue-600');
        }
    });
}


    function colorRateOfReturn() {
    document.querySelectorAll('#stock-list li').forEach(row => {
        const realizedPLEl = row.querySelector('.realized-pl-name');
        const rateOfReturnEl = row.querySelector('.rate-of-return-name');

        if (!realizedPLEl || !rateOfReturnEl) return;

        let val = parseFloat(realizedPLEl.value.replace(/,/g, ''));

        // 먼저 색상 초기화
        rateOfReturnEl.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500');

        if (isNaN(val) || val === 0) {
            rateOfReturnEl.classList.add('text-gray-500');
        } else if (val > 0) {
            rateOfReturnEl.classList.add('text-red-600');
        } else {
            rateOfReturnEl.classList.add('text-blue-600');
        }
    });
}

    document.addEventListener('DOMContentLoaded', () => {
        attachNumberFormatting();
        const form = document.querySelector('form[name="interest-group-form"]');
        if (form) {
            form.addEventListener('submit', (e) => {
                const stockRows = document.querySelectorAll('#stock-list li');
                const errorBox = document.getElementById('form-error');
                if (stockRows.length === 0) {
                    e.preventDefault();
                    errorBox.classList.remove('hidden');
                    return;
                } else {
                    errorBox.classList.add('hidden');
                }

                const numberFields = document.querySelectorAll(
                    '.buying-price-name, .num-of-stocks-name, .total-buying-price-name, .break-even-price-name'
                );
                numberFields.forEach(field => field.value = field.value.replace(/,/g, ''));
            });
        }
    });
</script>
</body>
</html>
