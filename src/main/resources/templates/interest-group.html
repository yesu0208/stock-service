<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주식 관심종목 저장소 - 관심종목 그룹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          darkMode: 'class'
        }
    </script>
    <script>
        (function() {
          const theme = localStorage.getItem('theme');
          if (theme === 'dark' ||
              (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        })();
    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        #stock-list input,
        #stock-list select {
          text-align: center;
        }
        .grid > div {
    text-align: center;
  }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen dark:bg-gray-900 dark:text-gray-100">
<!-- 로딩 화면 -->
<div id="loading-screen" class="fixed inset-0 bg-white dark:bg-gray-900 flex flex-col items-center justify-center z-50 space-y-4">
    <!-- 회전하는 동그라미 -->
    <div class="w-12 h-12 border-4 border-gray-300 border-t-sky-600 rounded-full animate-spin"></div>

    <!-- 깜빡이는 텍스트 -->
    <div class="text-gray-800 dark:text-gray-100 text-xl font-bold animate-pulse">
        잠시만 기다려주세요...
    </div>
</div>

<header class="bg-white shadow dark:bg-gray-800 dark:text-gray-100">
    <div class="container mx-auto px-4 py-6 flex justify-between items-center">
        <a th:href="@{/}" class="text-2xl font-bold text-sky-600">주식 관심종목 저장소</a>

        <nav class="ml-auto flex items-center space-x-4">
            <a th:href="@{/interest-group/my-groups}"
               class="text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
                내 관심그룹
            </a>
            <a th:href="@{/my-account}"
               class="text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
                내 정보
            </a>
            <a th:href="@{/oauth2/authorization/github}" sec:authorize="!isAuthenticated()"
               class="text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
                <i class="fab fa-github"></i> 로그인
            </a>
            <a th:href="@{/logout}" sec:authorize="isAuthenticated()"
               class="text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
        <span sec:authentication="principal.name"
              class="text-gray-400 dark:text-gray-300 text-sm mx-1">username</span>
                로그아웃
            </a>

            <!-- 다크 모드 토글 버튼 -->
            <button id="darkModeToggle"
                    class="ml-4 text-gray-600 dark:text-gray-300 hover:text-sky-600 dark:hover:text-sky-400">
                <i id="darkModeIcon" class="fas fa-moon"></i>
            </button>
        </nav>
    </div>
</header>

<main class="container mx-auto px-4 py-8 flex-grow">
    <form name="interest-group-form" th:action="@{/interest-group}" method="post">
        <section class="bg-white shadow rounded-lg p-6 mb-6 dark:bg-gray-800" th:object="${interestGroup}">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 dark:text-gray-100">관심종목 그룹 만들기</h2>

            <!-- 🔹 경고메시지 영역 -->
            <div id="form-error" class="hidden mb-4 text-red-600 text-sm font-medium">
                ❗ 최소 1개 이상의 종목을 추가해야 합니다.
            </div>

            <div class="flex items-center space-x-4 mb-4">
                <label for="groupName" class="block text-sm font-medium text-gray-500 dark:text-gray-300 w-24">그룹이름</label>
                <input type="text" id="groupName" th:field="*{groupName}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100">
            </div>

            <hr class="mb-4 border-gray-200 dark:border-gray-700">

            <div class="grid grid-cols-[1.5fr_1fr_1fr_1fr_1fr_1fr_1fr_1.5fr_50px] gap-4 mb-4">
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">종목명</div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">매입가</div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">보유수량</div>
                <div class="flex flex-col text-sm font-medium text-gray-400 dark:text-gray-300">
                    <span>매입금액</span>
                    <span>평가금액</span>
                </div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">평가손익</div>
                <div class="flex flex-col text-sm font-medium text-gray-400 dark:text-gray-300">
                    <span>실현손익</span>
                    <span>수익률</span>
                </div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">손익분기매입가</div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300">현재주가</div>
                <div class="block text-sm font-medium text-gray-400 dark:text-gray-300"></div>
            </div>

            <div id="interest-stock-list">
                <ul id="stock-list" class="list bg-white dark:bg-gray-900">
                    <li th:data-id="${iterStat.index + 1}"
                        class="grid grid-cols-[1.5fr_1fr_1fr_1fr_1fr_1fr_1fr_1.5fr_50px] gap-4 mb-4 bg-white dark:bg-gray-900"
                        th:each="item, iterStat : *{interestStocks}">

                        <!-- 종목명 -->
                        <div class="flex items-center">
                            <i class="handle fas fa-grip-lines mr-2 cursor-move"></i>
                            <label>
                                <select th:field="*{interestStocks[__${iterStat.index}__].stockName}"
                                        class="stock-name-id stock-name-name mt-1 block w-full border-gray-300 rounded-md shadow-sm
                                   dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100"
                                        required>
                                    <option value="" disabled selected>-- 종목선택 --</option>
                                    <option th:each="type : ${stockNames}" th:value="${type}" th:text="${type}">Type</option>
                                </select>
                            </label>
                        </div>

                        <!-- 매입가 -->
                        <div class="flex items-center">
                            <input type="text" th:field="*{interestStocks[__${iterStat.index}__].buyingPrice}"
                                   class="buying-price-id buying-price-name mt-1 block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100">
                        </div>

                        <!-- 보유수량 -->
                        <div class="flex items-center">
                            <input type="text" th:field="*{interestStocks[__${iterStat.index}__].numOfStocks}"
                                   class="num-of-stocks-id num-of-stocks-name mt-1 block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100">
                        </div>

                        <!-- 매입금액 + 평가금액 -->
                        <div class="flex flex-col space-y-1">
                            <input type="text" th:field="*{interestStocks[__${iterStat.index}__].totalBuyingPrice}"
                                   class="total-buying-price-id total-buying-price-name block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                            <input type="text" th:value="${item.valuation}"
                                   class="valuation-id valuation-name block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                        </div>

                        <!-- 평가손익 -->
                        <div class="flex items-center">
                            <input type="text" th:value="${item.unrealizedPL}"
                                   class="unrealized-pl-id unrealized-pl-name mt-1 block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                        </div>

                        <!-- 실현손익 + 수익률 -->
                        <div class="flex flex-col space-y-1">
                            <input type="text" th:value="${item.realizedPL}"
                                   class="realized-pl-id realized-pl-name block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                            <input type="text" th:value="${item.rateOfReturnString}"
                                   class="rate-of-return-id rate-of-return-name block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                        </div>

                        <!-- 손익분기매입가 -->
                        <div class="flex items-center">
                            <input type="text" th:field="*{interestStocks[__${iterStat.index}__].breakEvenPrice}"
                                   class="break-even-price-id break-even-price-name mt-1 block w-full border-gray-300 rounded-md shadow-sm
                              dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100" readonly>
                        </div>

                        <!-- 현재주가 / 상승가 / 상승률 세로 배치 -->
                        <div class="flex flex-col space-y-1 relative">
                            <!-- 위: 현재주가 -->
                            <div class="flex items-center">
                                <input type="text"
                                       th:value="${item.nowValue}"
                                       class="current-price-id current-price-name block w-full border-gray-300 rounded-md shadow-sm
                      dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100"
                                       readonly>
                            </div>

                            <!-- 아래: 상승가 + 상승률 -->
                            <div class="flex items-center space-x-2">
                                <span class="change-icon w-4 text-center"></span>
                                <input type="text"
                                       th:value="${item.changeValue}"
                                       class="change-value-id change-value-name block w-1/2 border-gray-300 rounded-md shadow-sm
                      dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100"
                                       readonly>
                                <input type="text"
                                       th:value="${item.changeRateString}"
                                       class="change-rate-id change-rate-name block w-1/2 border-gray-300 rounded-md shadow-sm
                      dark:bg-gray-900 dark:border-gray-600 dark:text-gray-100"
                                       readonly>
                            </div>
                        </div>

                        <!-- 삭제 버튼 전용 칸 -->
                        <div class="flex items-center justify-center">
                            <i class="delete-row fas fa-trash ml-2 cursor-pointer"></i>
                        </div>

                        <input type="hidden" th:field="*{interestStocks[__${iterStat.index}__].fieldOrder}"
                               class="field-order-id field-order-name field-order-value">
                    </li>
                </ul>
            </div>

            <button type="button" id="add-row" class="mt-4 bg-sky-600 dark:bg-sky-500 text-white py-2 px-4 rounded hover:bg-sky-700 dark:hover:bg-sky-600">종목 추가</button>
            <button type="submit" class="mt-4 bg-sky-600 dark:bg-sky-500 text-white py-2 px-4 rounded hover:bg-sky-700 dark:hover:bg-sky-600">저장</button>
        </section>
    </form>
</main>

<footer class="bg-white shadow w-full mt-auto dark:bg-gray-800 dark:text-gray-400">
    <div class="container mx-auto px-4 py-6 text-center text-gray-600 dark:text-gray-300" >
        © 2025 Arile, Inc
    </div>
</footer>

<script>
    const interestStockList = new List('interest-stock-list', {
        valueNames: [
            { data: ['id'] },
            { name: 'stock-name-id', attr: 'id' },
            { name: 'stock-name-name', attr: 'name' },
            { name: 'buying-price-id', attr: 'id' },
            { name: 'buying-price-name', attr: 'name' },
            { name: 'num-of-stocks-id', attr: 'id' },
            { name: 'num-of-stocks-name', attr: 'name' },
            { name: 'total-buying-price-id', attr: 'id' },
            { name: 'total-buying-price-name', attr: 'name' },
            { name: 'valuation-id', attr: 'id' },
            { name: 'valuation-name', attr: 'name' },
            { name: 'unrealized-pl-id', attr: 'id' },
            { name: 'unrealized-pl-name', attr: 'name' },
            { name: 'realized-pl-id', attr: 'id' },
            { name: 'realized-pl-name', attr: 'name' },
            { name: 'rate-of-return-id', attr: 'id' },
            { name: 'rate-of-return-name', attr: 'name' },
            { name: 'break-even-price-id', attr: 'id' },
            { name: 'break-even-price-name', attr: 'name' },
            { name: 'current-price-id', attr: 'id' },
            { name: 'current-price-name', attr: 'name' },
            { name: 'change-value-id', attr: 'id' },
            { name: 'change-value-name', attr: 'name' },
            { name: 'change-rate-id', attr: 'id' },
            { name: 'change-rate-name', attr: 'name' },
            { name: 'field-order-id', attr: 'id' },
            { name: 'field-order-name', attr: 'name' },
            { name: 'field-order-value', attr: 'value' },
        ]
    });
    interestStockList.sort('field-order-value', { order: 'asc' });

    const sortable = new Sortable.create(document.getElementById('stock-list'), {
        handle: '.handle',
        animation: 150,
        onUpdate: () => { resetData(interestStockList); }
    });

    document.querySelectorAll('.delete-row').forEach(btn => {
        enrollDeleteRowEvent(btn, interestStockList);
    });

    interestStockList.on('updated', list => resetData(list));

    document.getElementById('add-row').addEventListener('click', () => {
        interestStockList.add({});
        const lastRow = interestStockList.items.at(-1).elm;

        lastRow.querySelectorAll(
            '.buying-price-name, .num-of-stocks-name, .total-buying-price-name, .valuation-name, .unrealized-pl-name, .realized-pl-name, .rate-of-return-name, .break-even-price-name, .current-price-name, .change-value-name, .change-rate-name'
        ).forEach(input => input.value = '');

        const selectBox = lastRow.querySelector('select');
        if (selectBox) selectBox.selectedIndex = 0;

        enrollDeleteRowEvent(lastRow.querySelector('.delete-row'), interestStockList);
        attachNumberFormatting();

        document.getElementById('form-error').classList.add('hidden');
    });

    function enrollDeleteRowEvent(btn, list) {
        btn.addEventListener('click', e => {
            const parentList = e.target.closest('li');
            const fieldOrderInput = parentList.querySelector('.field-order-value');
            if (fieldOrderInput) list.remove('field-order-value', fieldOrderInput.value);
            parentList.remove();
        });
    }

    function resetData(list) {
        list.reIndex();
        for (const [index, item] of list.items.entries()) {
            item.values({
                'id': index + 1,
                'stock-name-id': `interestStocks${index}.stockName`,
                'stock-name-name': `interestStocks[${index}].stockName`,
                'buying-price-id': `interestStocks${index}.buyingPrice`,
                'buying-price-name': `interestStocks[${index}].buyingPrice`,
                'num-of-stocks-id': `interestStocks${index}.numOfStocks`,
                'num-of-stocks-name': `interestStocks[${index}].numOfStocks`,
                'total-buying-price-id': `interestStocks${index}.totalBuyingPrice`,
                'total-buying-price-name': `interestStocks[${index}].totalBuyingPrice`,

                'valuation-id': `interestStocks${index}.valuation`,
                'valuation-name': `interestStocks[${index}].valuation`,
                'unrealized-pl-id': `interestStocks${index}.unrealizedPL`,
                'unrealized-pl-name': `interestStocks[${index}].unrealizedPL`,
                'realized-pl-id': `interestStocks${index}.realizedPL`,
                'realized-pl-name': `interestStocks[${index}].realizedPL`,
                'rate-of-return-id': `interestStocks${index}.rateOfReturnString`,
                'rate-of-return-name': `interestStocks[${index}].rateOfReturnString`,

                'break-even-price-id': `interestStocks${index}.breakEvenPrice`,
                'break-even-price-name': `interestStocks[${index}].breakEvenPrice`,
                'current-price-id': `interestStocks${index}.nowValue`,
                'current-price-name': `interestStocks[${index}].nowValue`,
                'change-value-id': `interestStocks${index}.changeValue`,
                'change-value-name': `interestStocks[${index}].changeValue`,
                'change-rate-id': `interestStocks${index}.changeRateString`,
                'change-rate-name': `interestStocks[${index}].changeRateString`,
                'field-order-id': `interestStocks${index}.fieldOrder`,
                'field-order-name': `interestStocks[${index}].fieldOrder`,
                'field-order-value': index + 1,
            });
        }
        colorChangeValues();
        colorChangeRates();
        colorRealizedPLValues();
        colorRateOfReturn();
    }

    function formatNumberInput(input) {
        let value = input.value.replace(/,/g, '');
        if (value === '' || isNaN(value)) {
            input.value = '';
            return;
        }
        value = Math.floor(Number(value));
        input.value = value.toLocaleString('ko-KR');
    }

    function attachNumberFormatting() {
        const numberFields = document.querySelectorAll(
            '.buying-price-name, .num-of-stocks-name, .total-buying-price-name, .valuation-name, .unrealized-pl-name, .realized-pl-name, .break-even-price-name, .current-price-name, .change-value-name'
        );
        numberFields.forEach(field => {
            field.addEventListener('input', () => {
                const start = field.selectionStart;
                formatNumberInput(field);
                field.setSelectionRange(start, start);
            });
            if (field.value) formatNumberInput(field);
        });
        colorChangeValues();
        colorChangeRates();
        colorRealizedPLValues();
        colorRateOfReturn();
    }

    function colorChangeValues() {
        document.querySelectorAll('.change-value-name').forEach(el => {
            const val = parseFloat(el.value.replace(/,/g, ''));
            const iconEl = el.closest('div').querySelector('.change-icon');
            if (isNaN(val)) {
                el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');
                if(iconEl) iconEl.textContent = '';
                return;
            }
            el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');
            if(iconEl) iconEl.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');

            if (val > 0) {
                el.classList.add('text-red-600', 'dark:text-red-400');
                if (iconEl) { iconEl.textContent = '▲'; iconEl.classList.add('text-red-600', 'dark:text-red-400'); }
            }
            else if (val < 0) {
                el.classList.add('text-blue-600', 'dark:text-blue-400');
                if (iconEl) { iconEl.textContent = '▼'; iconEl.classList.add('text-blue-600', 'dark:text-blue-400'); }
            }
            else {
                el.classList.add('text-gray-500', 'dark:text-gray-400');
                if (iconEl) { iconEl.textContent = '-'; iconEl.classList.add('text-gray-500', 'dark:text-gray-400'); }
            }
        });
    }


    function colorRealizedPLValues() {
        document.querySelectorAll('.realized-pl-name').forEach(el => {
            const val = parseFloat(el.value.replace(/,/g, ''));
            if (isNaN(val)) {
                el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');
                return;
            }
            el.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');

            if (val > 0) {
                el.classList.add('text-red-600', 'dark:text-red-400');
            }
            else if (val < 0) {
                el.classList.add('text-blue-600', 'dark:text-blue-400');
            }
            else {
                el.classList.add('text-gray-500', 'dark:text-gray-400');
            }
        });
    }


    function colorChangeRates() {
    document.querySelectorAll('#stock-list li').forEach(row => {
        const changeRateEl = row.querySelector('.change-rate-name');
        const changeValueEl = row.querySelector('.change-value-name');

        if (!changeRateEl || !changeValueEl) return;

        let val = parseFloat(changeValueEl.value.replace(/,/g, ''));

        // 먼저 색상 초기화
        changeRateEl.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
      'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');

        if (isNaN(val) || val === 0) {
            changeRateEl.classList.add('text-gray-500', 'dark:text-gray-400');
        } else if (val > 0) {
            changeRateEl.classList.add('text-red-600', 'dark:text-red-400');
        } else {
            changeRateEl.classList.add('text-blue-600', 'dark:text-blue-400');
        }
    });
}


    function colorRateOfReturn() {
    document.querySelectorAll('#stock-list li').forEach(row => {
        const realizedPLEl = row.querySelector('.realized-pl-name');
        const rateOfReturnEl = row.querySelector('.rate-of-return-name');

        if (!realizedPLEl || !rateOfReturnEl) return;

        let val = parseFloat(realizedPLEl.value.replace(/,/g, ''));

        // 먼저 색상 초기화
        rateOfReturnEl.classList.remove('text-red-600', 'text-blue-600', 'text-gray-500',
        'dark:text-red-400', 'dark:text-blue-400', 'dark:text-gray-400');

        if (isNaN(val) || val === 0) {
            rateOfReturnEl.classList.add('text-gray-500', 'dark:text-gray-400');
        } else if (val > 0) {
            rateOfReturnEl.classList.add('text-red-600', 'dark:text-red-400');
        } else {
            rateOfReturnEl.classList.add('text-blue-600', 'dark:text-blue-400');
        }
    });
}

    document.addEventListener('DOMContentLoaded', () => {
        attachNumberFormatting();
        const form = document.querySelector('form[name="interest-group-form"]');
        if (form) {
            form.addEventListener('submit', (e) => {
                const stockRows = document.querySelectorAll('#stock-list li');
                const errorBox = document.getElementById('form-error');
                if (stockRows.length === 0) {
                    e.preventDefault();
                    errorBox.classList.remove('hidden');
                    return;
                } else {
                    errorBox.classList.add('hidden');
                }

                const numberFields = document.querySelectorAll(
                    '.buying-price-name, .num-of-stocks-name, .total-buying-price-name, .break-even-price-name'
                );
                numberFields.forEach(field => field.value = field.value.replace(/,/g, ''));
            });
        }
    });
</script>

<script>
    const toggleBtn = document.getElementById("darkModeToggle");
    const icon = document.getElementById("darkModeIcon");
    const root = document.documentElement;

    // 저장된 모드 불러오기
    if (localStorage.getItem("theme") === "dark") {
      root.classList.add("dark");
      icon.classList.replace("fa-moon","fa-sun");
    }

    toggleBtn.addEventListener("click", () => {
      const isDark = root.classList.toggle("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      icon.classList.toggle("fa-moon", !isDark);
      icon.classList.toggle("fa-sun", isDark);
    });
</script>
<script>
    window.addEventListener('load', () => {
      const loadingScreen = document.getElementById('loading-screen');
      if (loadingScreen) {
        loadingScreen.style.transition = "opacity 0.5s";
        loadingScreen.style.opacity = 0;
        setTimeout(() => loadingScreen.remove(), 500);
      }
    });
</script>
</body>
</html>
